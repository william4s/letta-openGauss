# Letta-OpenGauss RAGç³»ç»Ÿ Dockeré•œåƒ
# æ”¯æŒOpenGausså‘é‡æ•°æ®åº“é›†æˆå’ŒBGE-M3 Embedding

# åŸºç¡€é•œåƒ - ä½¿ç”¨å®˜æ–¹Python 3.11é•œåƒ
FROM python:3.11-slim AS base

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive \
    POETRY_NO_INTERACTION=1 \
    POETRY_VIRTUALENVS_IN_PROJECT=1 \
    POETRY_VIRTUALENVS_CREATE=1 \
    POETRY_CACHE_DIR=/tmp/poetry_cache

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    libpq-dev \
    python3-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# æ„å»ºé˜¶æ®µ
FROM base AS builder

WORKDIR /app

# å®‰è£…Poetry
RUN pip install --no-cache-dir poetry==1.8.3

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY pyproject.toml poetry.lock ./
COPY . .

# å®‰è£…Pythonä¾èµ–
RUN poetry lock --no-update && \
    poetry install --all-extras --no-dev && \
    rm -rf $POETRY_CACHE_DIR

# è¿è¡Œæ—¶é˜¶æ®µ
FROM base AS runtime

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r letta && useradd -r -g letta letta

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶è™šæ‹Ÿç¯å¢ƒå’Œåº”ç”¨ä»£ç 
COPY --from=builder --chown=letta:letta /app .

# è®¾ç½®è™šæ‹Ÿç¯å¢ƒè·¯å¾„
ENV PATH="/app/.venv/bin:$PATH"

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/logs /app/data /app/reports /app/templates && \
    chown -R letta:letta /app

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY --chown=letta:letta <<EOF /app/docker-entrypoint.sh
#!/bin/bash
set -e

echo "ğŸš€ Starting Letta-OpenGauss RAG System..."

# ç­‰å¾…æ•°æ®åº“å¯ç”¨
if [ -n "\$LETTA_PG_URI" ]; then
    echo "â³ Waiting for OpenGauss database to be ready..."
    until pg_isready -d "\$LETTA_PG_URI"; do
        echo "Database is unavailable - sleeping"
        sleep 2
    done
    echo "âœ… Database is ready!"
fi

# è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
if [ "\${AUTO_MIGRATE:-true}" = "true" ]; then
    echo "ğŸ”„ Running database migrations..."
    python migrate_to_opengauss_compatibility.py || echo "âš ï¸ Migration completed with warnings"
fi

# è®¾ç½®æƒé™
if [ -n "\$LETTA_SANDBOX_MOUNT_PATH" ]; then
    chmod 777 "\$LETTA_SANDBOX_MOUNT_PATH" || echo "âš ï¸ Could not set sandbox permissions"
fi

# å¯åŠ¨æœåŠ¡
echo "ğŸ¯ Starting Letta server on \${HOST:-0.0.0.0}:\${PORT:-8283}..."
exec python -m letta.server --host \${HOST:-0.0.0.0} --port \${PORT:-8283}
EOF

RUN chmod +x /app/docker-entrypoint.sh

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER letta

# æš´éœ²ç«¯å£
EXPOSE 8283

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8283/v1/health || exit 1

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/app/docker-entrypoint.sh"]